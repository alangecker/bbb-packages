function module(e,r,t){let s,o;t.link("/imports/startup/client/logger",{default(e){s=e}},0),t.link("/imports/ui/services/bbb-webrtc-sfu/sfu-base-broker",{default(e){o=e}},1);const i="iceCandidate",n="subscriberAnswer",a="fullaudio";class d extends o{constructor(e,r,t,s,o){let i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};super(a,e),this.voiceBridge=r,this.userId=t,this.internalMeetingId=s,this.role=o,this.offering=!0,Object.assign(this,i)}joinAudio(){return new Promise(((e,r)=>{const t={mediaConstraints:{audio:!0,video:!1},onicecandidate:e=>{this.onIceCandidate(e,this.role)}};this.addIceServers(t);const i="sendrecv"===this.role?kurentoUtils.WebRtcPeer.WebRtcPeerSendrecv:kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly;return window.kurento=kurentoUtils.WebRtcPeer,this.webRtcPeer=i(t,(t=>{if(t){const e=o.assembleError(1305);return s.error({logCode:"".concat(this.logCodePrefix,"_peer_creation_failed"),extraInfo:{errorMessage:t.name||t.message||"Unknown error",errorCode:e.errorCode,sfuComponent:this.sfuComponent,started:this.started}},"Audio peer creation failed"),this.onerror(e),r(e)}return this.webRtcPeer.iceQueue=[],this.offering?this.webRtcPeer.generateOffer(this.onOfferGenerated.bind(this)):this.sendStartReq(),e()})),this.webRtcPeer.peerConnection.onconnectionstatechange=this.handleConnectionStateChange.bind(this),e()}))}listen(){return this.openWSConnection().then(this.joinAudio.bind(this))}onWSMessage(e){const r=JSON.parse(e.data);switch(r.id){case"startResponse":this.onRemoteDescriptionReceived(r);break;case"iceCandidate":this.handleIceCandidate(r.candidate);break;case"webRTCAudioSuccess":this.onstart(r.success),this.started=!0;break;case"webRTCAudioError":case"error":this.handleSFUError(r);break;case"pong":break;default:s.debug({logCode:"".concat(this.logCodePrefix,"_invalid_req"),extraInfo:{messageId:r.id||"Unknown",sfuComponent:this.sfuComponent}},"Discarded invalid SFU message")}}handleSFUError(e){const{code:r,reason:t,role:i}=e,n=o.assembleError(r,t);s.error({logCode:"".concat(this.logCodePrefix,"_sfu_error"),extraInfo:{errorCode:r,errorMessage:n.errorMessage,role:i,sfuComponent:this.sfuComponent,started:this.started}},"Listen only failed in SFU"),this.onerror(n)}sendLocalDescription(e){const r={id:n,type:this.sfuComponent,role:this.role,voiceBridge:this.voiceBridge,sdpOffer:e};this.sendMessage(r)}onRemoteDescriptionReceived(e){return this.offering?this.processAnswer(e):this.processOffer(e)}sendStartReq(e){const r={id:"start",type:this.sfuComponent,role:this.role,internalMeetingId:this.internalMeetingId,voiceBridge:this.voiceBridge,caleeName:this.caleeName,userId:this.userId,userName:this.userName,sdpOffer:e,mediaServer:this.mediaServer};s.debug({logCode:"".concat(this.logCodePrefix,"_offer_generated"),extraInfo:{sfuComponent:this.sfuComponent,role:this.role}},"SFU audio offer generated"),this.sendMessage(r)}onOfferGenerated(e,r){if(e)return s.error({logCode:"".concat(this.logCodePrefix,"_offer_failure"),extraInfo:{errorMessage:e.name||e.message||"Unknown error",sfuComponent:this.sfuComponent}},"Listen only offer generation failed"),this.onerror(e);this.sendStartReq(r)}onIceCandidate(e,r){const t={id:i,role:r,type:this.sfuComponent,voiceBridge:this.voiceBridge,candidate:e};this.sendMessage(t)}}t.exportDefault(d)}

