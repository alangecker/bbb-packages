{"version":3,"sources":["meteor://ðŸ’»app/packages/ddp-server/stream_server.js","meteor://ðŸ’»app/packages/ddp-server/livedata_server.js","meteor://ðŸ’»app/packages/ddp-server/writefence.js","meteor://ðŸ’»app/packages/ddp-server/crossbar.js","meteor://ðŸ’»app/packages/ddp-server/server_convenience.js"],"names":["websocketExtensions","_","once","extensions","websocketCompressionConfig","process","env","SERVER_WEBSOCKET_COMPRESSION","JSON","parse","push","Npm","require","configure","pathPrefix","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","StreamServer","self","registration_callbacks","open_sockets","prefix","RoutePolicy","declare","sockjs","serverOptions","log","heartbeat_delay","disconnect_delay","jsessionid","USE_JSESSIONID","DISABLE_WEBSOCKETS","websocket","faye_server_options","server","createServer","WebApp","httpServer","removeListener","_timeoutAdjustmentRequestCallback","installHandlers","addListener","_redirectWebsocketEndpoint","on","socket","setWebsocketTimeout","timeout","protocol","_session","recv","connection","setTimeout","send","data","write","without","TEST_METADATA","stringify","testMessageOnConnect","each","callback","Object","assign","prototype","register","all_sockets","values","forEach","event","oldHttpServerListeners","listeners","slice","removeAllListeners","newListener","request","args","arguments","url","parsedUrl","pathname","format","oldListener","apply","DDPServer","Fiber","SessionDocumentView","existsIn","Set","dataByKey","Map","_SessionDocumentView","extend","getFields","ret","precedenceList","key","value","clearField","subscriptionHandle","changeCollector","get","removedValue","undefined","i","length","precedence","splice","delete","EJSON","equals","changeField","isAdd","clone","has","set","elt","find","SessionCollectionView","collectionName","sessionCallbacks","documents","callbacks","_SessionCollectionView","isEmpty","size","diff","previous","DiffSequence","diffMaps","both","bind","diffDocument","rightOnly","id","nowDV","added","leftOnly","prevDV","removed","fields","diffObjects","prev","now","changed","docView","add","changedResult","Error","err","Session","version","options","Random","initialized","inQueue","Meteor","_DoubleEndedQueue","blocked","workerRunning","cachedUnblock","_namedSubs","_universalSubs","userId","collectionViews","_isSending","_dontStartNewUniversalSubs","_pendingReady","_closeCallbacks","_socketUrl","_respondToPings","respondToPings","connectionHandle","close","onClose","fn","cb","bindEnvironment","defer","clientAddress","_clientAddress","httpHeaders","headers","msg","session","startUniversalSubs","run","heartbeatInterval","heartbeat","DDPCommon","Heartbeat","heartbeatTimeout","onTimeout","sendPing","start","Package","Facts","incrementServerFact","sendReady","subscriptionIds","subs","subscriptionId","sendAdded","collection","sendChanged","sendRemoved","getSendCallbacks","getCollectionView","view","handlers","universal_publish_handlers","handler","_startSubscription","stop","_meteorSession","_deactivateAllSubscriptions","_removeSession","_printSentDDP","_debug","stringifyDDP","sendError","reason","offendingMessage","processMessage","msg_in","messageReceived","processNext","shift","unblock","onMessageHook","protocol_handlers","call","sub","name","params","Array","publish_handlers","error","DDPRateLimiter","rateLimiterInput","type","connectionId","_increment","rateLimitResult","_check","allowed","getErrorMessage","timeToReset","unsub","_stopSubscription","method","randomSeed","fence","_WriteFence","onAllCommitted","retire","methods","method_handlers","arm","setUserId","_setUserId","invocation","MethodInvocation","isSimulation","promise","Promise","resolve","reject","_CurrentWriteFence","withValue","DDP","_CurrentMethodInvocation","maybeAuditArgumentChecks","finish","payload","then","result","exception","wrapInternalException","_eachSub","f","_diffCollectionViews","beforeCVs","leftValue","rightValue","doc","_deactivate","oldNamedSubs","newSub","_recreate","_runHandler","_noYieldsAllowed","subId","Subscription","unblockHander","subName","maybeSub","_name","_removeAllDocuments","response","httpForwardedCount","parseInt","remoteAddress","forwardedFor","isString","trim","split","_handler","_subscriptionId","_params","_subscriptionHandle","_deactivated","_stopCallbacks","_documents","_ready","_idFilter","idStringify","MongoID","idParse","resultOrThenable","_CurrentPublicationInvocation","e","_isDeactivated","isThenable","_publishHandlerResult","res","isCursor","c","_publishCursor","ready","isArray","all","collectionNames","_getCollectionName","cur","_callStopCallbacks","collectionDocs","strId","onStop","ids","Server","defaults","onConnectionHook","Hook","debugPrintExceptions","sessions","stream_server","raw_msg","_printReceivedDDP","parseDDP","_handleConnect","onConnection","onMessage","support","contains","SUPPORTED_DDP_VERSIONS","calculateVersion","publish","isObject","autopublish","is_auto","warned_about_autopublish","func","pop","callAsync","applyAsync","await","currentMethodInvocation","currentPublicationInvocation","makeRpcSeed","_urlForSession","sessionId","clientSupportedVersions","serverSupportedVersions","correctVersion","_calculateVersion","context","isClientSafe","originalMessage","message","details","_expectedByTest","stack","sanitizedError","description","Match","_failIfArgumentsAreNotAllChecked","Future","armed","fired","retired","outstanding_writes","before_fire_callbacks","completion_callbacks","EnvironmentVariable","beginWrite","committed","_maybeFire","onBeforeFire","armAndWait","future","wait","invokeCallback","_Crossbar","nextId","listenersByCollection","listenersByCollectionCount","factPackage","factName","_collectionForMessage","listen","trigger","record","fire","notification","listenersForCollection","callbackIds","l","_matches","ObjectID","triggerValue","_InvalidationCrossbar","DDP_DEFAULT_CONNECTION_URL","refresh"],"mappings":"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","file":"/packages/ddp-server.js","sourcesContent":["// By default, we use the permessage-deflate extension with default\n// configuration. If $SERVER_WEBSOCKET_COMPRESSION is set, then it must be valid\n// JSON. If it represents a falsey value, then we do not use permessage-deflate\n// at all; otherwise, the JSON value is used as an argument to deflate's\n// configure method; see\n// https://github.com/faye/permessage-deflate-node/blob/master/README.md\n//\n// (We do this in an _.once instead of at startup, because we don't want to\n// crash the tool during isopacket load if your JSON doesn't parse. This is only\n// a problem because the tool has to load the DDP server code just in order to\n// be a DDP client; see https://github.com/meteor/meteor/issues/3452 .)\nvar websocketExtensions = _.once(function () {\n  var extensions = [];\n\n  var websocketCompressionConfig = process.env.SERVER_WEBSOCKET_COMPRESSION\n        ? JSON.parse(process.env.SERVER_WEBSOCKET_COMPRESSION) : {};\n  if (websocketCompressionConfig) {\n    extensions.push(Npm.require('permessage-deflate').configure(\n      websocketCompressionConfig\n    ));\n  }\n\n  return extensions;\n});\n\nvar pathPrefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX ||  \"\";\n\nStreamServer = function () {\n  var self = this;\n  self.registration_callbacks = [];\n  self.open_sockets = [];\n\n  // Because we are installing directly onto WebApp.httpServer instead of using\n  // WebApp.app, we have to process the path prefix ourselves.\n  self.prefix = pathPrefix + '/sockjs';\n  RoutePolicy.declare(self.prefix + '/', 'network');\n\n  // set up sockjs\n  var sockjs = Npm.require('sockjs');\n  var serverOptions = {\n    prefix: self.prefix,\n    log: function() {},\n    // this is the default, but we code it explicitly because we depend\n    // on it in stream_client:HEARTBEAT_TIMEOUT\n    heartbeat_delay: 45000,\n    // The default disconnect_delay is 5 seconds, but if the server ends up CPU\n    // bound for that much time, SockJS might not notice that the user has\n    // reconnected because the timer (of disconnect_delay ms) can fire before\n    // SockJS processes the new connection. Eventually we'll fix this by not\n    // combining CPU-heavy processing with SockJS termination (eg a proxy which\n    // converts to Unix sockets) but for now, raise the delay.\n    disconnect_delay: 60 * 1000,\n    // Set the USE_JSESSIONID environment variable to enable setting the\n    // JSESSIONID cookie. This is useful for setting up proxies with\n    // session affinity.\n    jsessionid: !!process.env.USE_JSESSIONID\n  };\n\n  // If you know your server environment (eg, proxies) will prevent websockets\n  // from ever working, set $DISABLE_WEBSOCKETS and SockJS clients (ie,\n  // browsers) will not waste time attempting to use them.\n  // (Your server will still have a /websocket endpoint.)\n  if (process.env.DISABLE_WEBSOCKETS) {\n    serverOptions.websocket = false;\n  } else {\n    serverOptions.faye_server_options = {\n      extensions: websocketExtensions()\n    };\n  }\n\n  self.server = sockjs.createServer(serverOptions);\n\n  // Install the sockjs handlers, but we want to keep around our own particular\n  // request handler that adjusts idle timeouts while we have an outstanding\n  // request.  This compensates for the fact that sockjs removes all listeners\n  // for \"request\" to add its own.\n  WebApp.httpServer.removeListener(\n    'request', WebApp._timeoutAdjustmentRequestCallback);\n  self.server.installHandlers(WebApp.httpServer);\n  WebApp.httpServer.addListener(\n    'request', WebApp._timeoutAdjustmentRequestCallback);\n\n  // Support the /websocket endpoint\n  self._redirectWebsocketEndpoint();\n\n  self.server.on('connection', function (socket) {\n    // sockjs sometimes passes us null instead of a socket object\n    // so we need to guard against that. see:\n    // https://github.com/sockjs/sockjs-node/issues/121\n    // https://github.com/meteor/meteor/issues/10468\n    if (!socket) return;\n\n    // We want to make sure that if a client connects to us and does the initial\n    // Websocket handshake but never gets to the DDP handshake, that we\n    // eventually kill the socket.  Once the DDP handshake happens, DDP\n    // heartbeating will work. And before the Websocket handshake, the timeouts\n    // we set at the server level in webapp_server.js will work. But\n    // faye-websocket calls setTimeout(0) on any socket it takes over, so there\n    // is an \"in between\" state where this doesn't happen.  We work around this\n    // by explicitly setting the socket timeout to a relatively large time here,\n    // and setting it back to zero when we set up the heartbeat in\n    // livedata_server.js.\n    socket.setWebsocketTimeout = function (timeout) {\n      if ((socket.protocol === 'websocket' ||\n           socket.protocol === 'websocket-raw')\n          && socket._session.recv) {\n        socket._session.recv.connection.setTimeout(timeout);\n      }\n    };\n    socket.setWebsocketTimeout(45 * 1000);\n\n    socket.send = function (data) {\n      socket.write(data);\n    };\n    socket.on('close', function () {\n      self.open_sockets = _.without(self.open_sockets, socket);\n    });\n    self.open_sockets.push(socket);\n\n    // only to send a message after connection on tests, useful for\n    // socket-stream-client/server-tests.js\n    if (process.env.TEST_METADATA && process.env.TEST_METADATA !== \"{}\") {\n      socket.send(JSON.stringify({ testMessageOnConnect: true }));\n    }\n\n    // call all our callbacks when we get a new socket. they will do the\n    // work of setting up handlers and such for specific messages.\n    _.each(self.registration_callbacks, function (callback) {\n      callback(socket);\n    });\n  });\n\n};\n\nObject.assign(StreamServer.prototype, {\n  // call my callback when a new socket connects.\n  // also call it for all current connections.\n  register: function (callback) {\n    var self = this;\n    self.registration_callbacks.push(callback);\n    _.each(self.all_sockets(), function (socket) {\n      callback(socket);\n    });\n  },\n\n  // get a list of all sockets\n  all_sockets: function () {\n    var self = this;\n    return _.values(self.open_sockets);\n  },\n\n  // Redirect /websocket to /sockjs/websocket in order to not expose\n  // sockjs to clients that want to use raw websockets\n  _redirectWebsocketEndpoint: function() {\n    var self = this;\n    // Unfortunately we can't use a connect middleware here since\n    // sockjs installs itself prior to all existing listeners\n    // (meaning prior to any connect middlewares) so we need to take\n    // an approach similar to overshadowListeners in\n    // https://github.com/sockjs/sockjs-node/blob/cf820c55af6a9953e16558555a31decea554f70e/src/utils.coffee\n    ['request', 'upgrade'].forEach((event) => {\n      var httpServer = WebApp.httpServer;\n      var oldHttpServerListeners = httpServer.listeners(event).slice(0);\n      httpServer.removeAllListeners(event);\n\n      // request and upgrade have different arguments passed but\n      // we only care about the first one which is always request\n      var newListener = function(request /*, moreArguments */) {\n        // Store arguments for use within the closure below\n        var args = arguments;\n\n        // TODO replace with url package\n        var url = Npm.require('url');\n\n        // Rewrite /websocket and /websocket/ urls to /sockjs/websocket while\n        // preserving query string.\n        var parsedUrl = url.parse(request.url);\n        if (parsedUrl.pathname === pathPrefix + '/websocket' ||\n            parsedUrl.pathname === pathPrefix + '/websocket/') {\n          parsedUrl.pathname = self.prefix + '/websocket';\n          request.url = url.format(parsedUrl);\n        }\n        _.each(oldHttpServerListeners, function(oldListener) {\n          oldListener.apply(httpServer, args);\n        });\n      };\n      httpServer.addListener(event, newListener);\n    });\n  }\n});\n","DDPServer = {};\n\nvar Fiber = Npm.require('fibers');\n\n// This file contains classes:\n// * Session - The server's connection to a single DDP client\n// * Subscription - A single subscription for a single client\n// * Server - An entire server that may talk to > 1 client. A DDP endpoint.\n//\n// Session and Subscription are file scope. For now, until we freeze\n// the interface, Server is package scope (in the future it should be\n// exported.)\n\n// Represents a single document in a SessionCollectionView\nvar SessionDocumentView = function () {\n  var self = this;\n  self.existsIn = new Set(); // set of subscriptionHandle\n  self.dataByKey = new Map(); // key-> [ {subscriptionHandle, value} by precedence]\n};\n\nDDPServer._SessionDocumentView = SessionDocumentView;\n\n\n_.extend(SessionDocumentView.prototype, {\n\n  getFields: function () {\n    var self = this;\n    var ret = {};\n    self.dataByKey.forEach(function (precedenceList, key) {\n      ret[key] = precedenceList[0].value;\n    });\n    return ret;\n  },\n\n  clearField: function (subscriptionHandle, key, changeCollector) {\n    var self = this;\n    // Publish API ignores _id if present in fields\n    if (key === \"_id\")\n      return;\n    var precedenceList = self.dataByKey.get(key);\n\n    // It's okay to clear fields that didn't exist. No need to throw\n    // an error.\n    if (!precedenceList)\n      return;\n\n    var removedValue = undefined;\n    for (var i = 0; i < precedenceList.length; i++) {\n      var precedence = precedenceList[i];\n      if (precedence.subscriptionHandle === subscriptionHandle) {\n        // The view's value can only change if this subscription is the one that\n        // used to have precedence.\n        if (i === 0)\n          removedValue = precedence.value;\n        precedenceList.splice(i, 1);\n        break;\n      }\n    }\n    if (precedenceList.length === 0) {\n      self.dataByKey.delete(key);\n      changeCollector[key] = undefined;\n    } else if (removedValue !== undefined &&\n               !EJSON.equals(removedValue, precedenceList[0].value)) {\n      changeCollector[key] = precedenceList[0].value;\n    }\n  },\n\n  changeField: function (subscriptionHandle, key, value,\n                         changeCollector, isAdd) {\n    var self = this;\n    // Publish API ignores _id if present in fields\n    if (key === \"_id\")\n      return;\n\n    // Don't share state with the data passed in by the user.\n    value = EJSON.clone(value);\n\n    if (!self.dataByKey.has(key)) {\n      self.dataByKey.set(key, [{subscriptionHandle: subscriptionHandle,\n                                value: value}]);\n      changeCollector[key] = value;\n      return;\n    }\n    var precedenceList = self.dataByKey.get(key);\n    var elt;\n    if (!isAdd) {\n      elt = precedenceList.find(function (precedence) {\n          return precedence.subscriptionHandle === subscriptionHandle;\n      });\n    }\n\n    if (elt) {\n      if (elt === precedenceList[0] && !EJSON.equals(value, elt.value)) {\n        // this subscription is changing the value of this field.\n        changeCollector[key] = value;\n      }\n      elt.value = value;\n    } else {\n      // this subscription is newly caring about this field\n      precedenceList.push({subscriptionHandle: subscriptionHandle, value: value});\n    }\n\n  }\n});\n\n/**\n * Represents a client's view of a single collection\n * @param {String} collectionName Name of the collection it represents\n * @param {Object.<String, Function>} sessionCallbacks The callbacks for added, changed, removed\n * @class SessionCollectionView\n */\nvar SessionCollectionView = function (collectionName, sessionCallbacks) {\n  var self = this;\n  self.collectionName = collectionName;\n  self.documents = new Map();\n  self.callbacks = sessionCallbacks;\n};\n\nDDPServer._SessionCollectionView = SessionCollectionView;\n\n\nObject.assign(SessionCollectionView.prototype, {\n\n  isEmpty: function () {\n    var self = this;\n    return self.documents.size === 0;\n  },\n\n  diff: function (previous) {\n    var self = this;\n    DiffSequence.diffMaps(previous.documents, self.documents, {\n      both: _.bind(self.diffDocument, self),\n\n      rightOnly: function (id, nowDV) {\n        self.callbacks.added(self.collectionName, id, nowDV.getFields());\n      },\n\n      leftOnly: function (id, prevDV) {\n        self.callbacks.removed(self.collectionName, id);\n      }\n    });\n  },\n\n  diffDocument: function (id, prevDV, nowDV) {\n    var self = this;\n    var fields = {};\n    DiffSequence.diffObjects(prevDV.getFields(), nowDV.getFields(), {\n      both: function (key, prev, now) {\n        if (!EJSON.equals(prev, now))\n          fields[key] = now;\n      },\n      rightOnly: function (key, now) {\n        fields[key] = now;\n      },\n      leftOnly: function(key, prev) {\n        fields[key] = undefined;\n      }\n    });\n    self.callbacks.changed(self.collectionName, id, fields);\n  },\n\n  added: function (subscriptionHandle, id, fields) {\n    var self = this;\n    var docView = self.documents.get(id);\n    var added = false;\n    if (!docView) {\n      added = true;\n      docView = new SessionDocumentView();\n      self.documents.set(id, docView);\n    }\n    docView.existsIn.add(subscriptionHandle);\n    var changeCollector = {};\n    _.each(fields, function (value, key) {\n      docView.changeField(\n        subscriptionHandle, key, value, changeCollector, true);\n    });\n    if (added)\n      self.callbacks.added(self.collectionName, id, changeCollector);\n    else\n      self.callbacks.changed(self.collectionName, id, changeCollector);\n  },\n\n  changed: function (subscriptionHandle, id, changed) {\n    var self = this;\n    var changedResult = {};\n    var docView = self.documents.get(id);\n    if (!docView)\n      throw new Error(\"Could not find element with id \" + id + \" to change\");\n    _.each(changed, function (value, key) {\n      if (value === undefined)\n        docView.clearField(subscriptionHandle, key, changedResult);\n      else\n        docView.changeField(subscriptionHandle, key, value, changedResult);\n    });\n    self.callbacks.changed(self.collectionName, id, changedResult);\n  },\n\n  removed: function (subscriptionHandle, id) {\n    var self = this;\n    var docView = self.documents.get(id);\n    if (!docView) {\n      var err = new Error(\"Removed nonexistent document \" + id);\n      throw err;\n    }\n    docView.existsIn.delete(subscriptionHandle);\n    if (docView.existsIn.size === 0) {\n      // it is gone from everyone\n      self.callbacks.removed(self.collectionName, id);\n      self.documents.delete(id);\n    } else {\n      var changed = {};\n      // remove this subscription from every precedence list\n      // and record the changes\n      docView.dataByKey.forEach(function (precedenceList, key) {\n        docView.clearField(subscriptionHandle, key, changed);\n      });\n\n      self.callbacks.changed(self.collectionName, id, changed);\n    }\n  }\n});\n\n/******************************************************************************/\n/* Session                                                                    */\n/******************************************************************************/\n\nvar Session = function (server, version, socket, options) {\n  var self = this;\n  self.id = Random.id();\n\n  self.server = server;\n  self.version = version;\n\n  self.initialized = false;\n  self.socket = socket;\n\n  // set to null when the session is destroyed. multiple places below\n  // use this to determine if the session is alive or not.\n  self.inQueue = new Meteor._DoubleEndedQueue();\n\n  self.blocked = false;\n  self.workerRunning = false;\n\n  self.cachedUnblock = null;\n\n  // Sub objects for active subscriptions\n  self._namedSubs = new Map();\n  self._universalSubs = [];\n\n  self.userId = null;\n\n  self.collectionViews = new Map();\n\n  // Set this to false to not send messages when collectionViews are\n  // modified. This is done when rerunning subs in _setUserId and those messages\n  // are calculated via a diff instead.\n  self._isSending = true;\n\n  // If this is true, don't start a newly-created universal publisher on this\n  // session. The session will take care of starting it when appropriate.\n  self._dontStartNewUniversalSubs = false;\n\n  // when we are rerunning subscriptions, any ready messages\n  // we want to buffer up for when we are done rerunning subscriptions\n  self._pendingReady = [];\n\n  // List of callbacks to call when this connection is closed.\n  self._closeCallbacks = [];\n\n\n  // XXX HACK: If a sockjs connection, save off the URL. This is\n  // temporary and will go away in the near future.\n  self._socketUrl = socket.url;\n\n  // Allow tests to disable responding to pings.\n  self._respondToPings = options.respondToPings;\n\n  // This object is the public interface to the session. In the public\n  // API, it is called the `connection` object.  Internally we call it\n  // a `connectionHandle` to avoid ambiguity.\n  self.connectionHandle = {\n    id: self.id,\n    close: function () {\n      self.close();\n    },\n    onClose: function (fn) {\n      var cb = Meteor.bindEnvironment(fn, \"connection onClose callback\");\n      if (self.inQueue) {\n        self._closeCallbacks.push(cb);\n      } else {\n        // if we're already closed, call the callback.\n        Meteor.defer(cb);\n      }\n    },\n    clientAddress: self._clientAddress(),\n    httpHeaders: self.socket.headers\n  };\n\n  self.send({ msg: 'connected', session: self.id });\n\n  // On initial connect, spin up all the universal publishers.\n  Fiber(function () {\n    self.startUniversalSubs();\n  }).run();\n\n  if (version !== 'pre1' && options.heartbeatInterval !== 0) {\n    // We no longer need the low level timeout because we have heartbeating.\n    socket.setWebsocketTimeout(0);\n\n    self.heartbeat = new DDPCommon.Heartbeat({\n      heartbeatInterval: options.heartbeatInterval,\n      heartbeatTimeout: options.heartbeatTimeout,\n      onTimeout: function () {\n        self.close();\n      },\n      sendPing: function () {\n        self.send({msg: 'ping'});\n      }\n    });\n    self.heartbeat.start();\n  }\n\n  Package['facts-base'] && Package['facts-base'].Facts.incrementServerFact(\n    \"livedata\", \"sessions\", 1);\n};\n\nObject.assign(Session.prototype, {\n\n  sendReady: function (subscriptionIds) {\n    var self = this;\n    if (self._isSending)\n      self.send({msg: \"ready\", subs: subscriptionIds});\n    else {\n      _.each(subscriptionIds, function (subscriptionId) {\n        self._pendingReady.push(subscriptionId);\n      });\n    }\n  },\n\n  sendAdded: function (collectionName, id, fields) {\n    var self = this;\n    if (self._isSending)\n      self.send({msg: \"added\", collection: collectionName, id: id, fields: fields});\n  },\n\n  sendChanged: function (collectionName, id, fields) {\n    var self = this;\n    if (_.isEmpty(fields))\n      return;\n\n    if (self._isSending) {\n      self.send({\n        msg: \"changed\",\n        collection: collectionName,\n        id: id,\n        fields: fields\n      });\n    }\n  },\n\n  sendRemoved: function (collectionName, id) {\n    var self = this;\n    if (self._isSending)\n      self.send({msg: \"removed\", collection: collectionName, id: id});\n  },\n\n  getSendCallbacks: function () {\n    var self = this;\n    return {\n      added: _.bind(self.sendAdded, self),\n      changed: _.bind(self.sendChanged, self),\n      removed: _.bind(self.sendRemoved, self)\n    };\n  },\n\n  getCollectionView: function (collectionName) {\n    var self = this;\n    var ret = self.collectionViews.get(collectionName);\n    if (!ret) {\n      ret = new SessionCollectionView(collectionName,\n                                        self.getSendCallbacks());\n      self.collectionViews.set(collectionName, ret);\n    }\n    return ret;\n  },\n\n  added: function (subscriptionHandle, collectionName, id, fields) {\n    var self = this;\n    var view = self.getCollectionView(collectionName);\n    view.added(subscriptionHandle, id, fields);\n  },\n\n  removed: function (subscriptionHandle, collectionName, id) {\n    var self = this;\n    var view = self.getCollectionView(collectionName);\n    view.removed(subscriptionHandle, id);\n    if (view.isEmpty()) {\n       self.collectionViews.delete(collectionName);\n    }\n  },\n\n  changed: function (subscriptionHandle, collectionName, id, fields) {\n    var self = this;\n    var view = self.getCollectionView(collectionName);\n    view.changed(subscriptionHandle, id, fields);\n  },\n\n  startUniversalSubs: function () {\n    var self = this;\n    // Make a shallow copy of the set of universal handlers and start them. If\n    // additional universal publishers start while we're running them (due to\n    // yielding), they will run separately as part of Server.publish.\n    var handlers = _.clone(self.server.universal_publish_handlers);\n    _.each(handlers, function (handler) {\n      self._startSubscription(handler);\n    });\n  },\n\n  // Destroy this session and unregister it at the server.\n  close: function () {\n    var self = this;\n\n    // Destroy this session, even if it's not registered at the\n    // server. Stop all processing and tear everything down. If a socket\n    // was attached, close it.\n\n    // Already destroyed.\n    if (! self.inQueue)\n      return;\n\n    // Drop the merge box data immediately.\n    self.inQueue = null;\n    self.collectionViews = new Map();\n\n    if (self.heartbeat) {\n      self.heartbeat.stop();\n      self.heartbeat = null;\n    }\n\n    if (self.socket) {\n      self.socket.close();\n      self.socket._meteorSession = null;\n    }\n\n    Package['facts-base'] && Package['facts-base'].Facts.incrementServerFact(\n      \"livedata\", \"sessions\", -1);\n\n    Meteor.defer(function () {\n      // stop callbacks can yield, so we defer this on close.\n      // sub._isDeactivated() detects that we set inQueue to null and\n      // treats it as semi-deactivated (it will ignore incoming callbacks, etc).\n      self._deactivateAllSubscriptions();\n\n      // Defer calling the close callbacks, so that the caller closing\n      // the session isn't waiting for all the callbacks to complete.\n      _.each(self._closeCallbacks, function (callback) {\n        callback();\n      });\n    });\n\n    // Unregister the session.\n    self.server._removeSession(self);\n  },\n\n  // Send a message (doing nothing if no socket is connected right now.)\n  // It should be a JSON object (it will be stringified.)\n  send: function (msg) {\n    var self = this;\n    if (self.socket) {\n      if (Meteor._printSentDDP)\n        Meteor._debug(\"Sent DDP\", DDPCommon.stringifyDDP(msg));\n      self.socket.send(DDPCommon.stringifyDDP(msg));\n    }\n  },\n\n  // Send a connection error.\n  sendError: function (reason, offendingMessage) {\n    var self = this;\n    var msg = {msg: 'error', reason: reason};\n    if (offendingMessage)\n      msg.offendingMessage = offendingMessage;\n    self.send(msg);\n  },\n\n  // Process 'msg' as an incoming message. (But as a guard against\n  // race conditions during reconnection, ignore the message if\n  // 'socket' is not the currently connected socket.)\n  //\n  // We run the messages from the client one at a time, in the order\n  // given by the client. The message handler is passed an idempotent\n  // function 'unblock' which it may call to allow other messages to\n  // begin running in parallel in another fiber (for example, a method\n  // that wants to yield.) Otherwise, it is automatically unblocked\n  // when it returns.\n  //\n  // Actually, we don't have to 'totally order' the messages in this\n  // way, but it's the easiest thing that's correct. (unsub needs to\n  // be ordered against sub, methods need to be ordered against each\n  // other.)\n  processMessage: function (msg_in) {\n    var self = this;\n    if (!self.inQueue) // we have been destroyed.\n      return;\n\n    // Respond to ping and pong messages immediately without queuing.\n    // If the negotiated DDP version is \"pre1\" which didn't support\n    // pings, preserve the \"pre1\" behavior of responding with a \"bad\n    // request\" for the unknown messages.\n    //\n    // Fibers are needed because heartbeat uses Meteor.setTimeout, which\n    // needs a Fiber. We could actually use regular setTimeout and avoid\n    // these new fibers, but it is easier to just make everything use\n    // Meteor.setTimeout and not think too hard.\n    //\n    // Any message counts as receiving a pong, as it demonstrates that\n    // the client is still alive.\n    if (self.heartbeat) {\n      Fiber(function () {\n        self.heartbeat.messageReceived();\n      }).run();\n    }\n\n    if (self.version !== 'pre1' && msg_in.msg === 'ping') {\n      if (self._respondToPings)\n        self.send({msg: \"pong\", id: msg_in.id});\n      return;\n    }\n    if (self.version !== 'pre1' && msg_in.msg === 'pong') {\n      // Since everything is a pong, nothing to do\n      return;\n    }\n\n    self.inQueue.push(msg_in);\n    if (self.workerRunning)\n      return;\n    self.workerRunning = true;\n\n    var processNext = function () {\n      var msg = self.inQueue && self.inQueue.shift();\n      if (!msg) {\n        self.workerRunning = false;\n        return;\n      }\n\n      Fiber(function () {\n        var blocked = true;\n\n        var unblock = function () {\n          if (!blocked)\n            return; // idempotent\n          blocked = false;\n          processNext();\n        };\n\n        self.server.onMessageHook.each(function (callback) {\n          callback(msg, self);\n          return true;\n        });\n\n        if (_.has(self.protocol_handlers, msg.msg))\n          self.protocol_handlers[msg.msg].call(self, msg, unblock);\n        else\n          self.sendError('Bad request', msg);\n        unblock(); // in case the handler didn't already do it\n      }).run();\n    };\n\n    processNext();\n  },\n\n  protocol_handlers: {\n    sub: function (msg, unblock) {\n      var self = this;\n\n      // cacheUnblock temporarly, so we can capture it later\n      // we will use unblock in current eventLoop, so this is safe\n      self.cachedUnblock = unblock;\n\n      // reject malformed messages\n      if (typeof (msg.id) !== \"string\" ||\n          typeof (msg.name) !== \"string\" ||\n          (('params' in msg) && !(msg.params instanceof Array))) {\n        self.sendError(\"Malformed subscription\", msg);\n        return;\n      }\n\n      if (!self.server.publish_handlers[msg.name]) {\n        self.send({\n          msg: 'nosub', id: msg.id,\n          error: new Meteor.Error(404, `Subscription '${msg.name}' not found`)});\n        return;\n      }\n\n      if (self._namedSubs.has(msg.id))\n        // subs are idempotent, or rather, they are ignored if a sub\n        // with that id already exists. this is important during\n        // reconnect.\n        return;\n\n      // XXX It'd be much better if we had generic hooks where any package can\n      // hook into subscription handling, but in the mean while we special case\n      // ddp-rate-limiter package. This is also done for weak requirements to\n      // add the ddp-rate-limiter package in case we don't have Accounts. A\n      // user trying to use the ddp-rate-limiter must explicitly require it.\n      if (Package['ddp-rate-limiter']) {\n        var DDPRateLimiter = Package['ddp-rate-limiter'].DDPRateLimiter;\n        var rateLimiterInput = {\n          userId: self.userId,\n          clientAddress: self.connectionHandle.clientAddress,\n          type: \"subscription\",\n          name: msg.name,\n          connectionId: self.id\n        };\n\n        DDPRateLimiter._increment(rateLimiterInput);\n        var rateLimitResult = DDPRateLimiter._check(rateLimiterInput);\n        if (!rateLimitResult.allowed) {\n          self.send({\n            msg: 'nosub', id: msg.id,\n            error: new Meteor.Error(\n              'too-many-requests',\n              DDPRateLimiter.getErrorMessage(rateLimitResult),\n              {timeToReset: rateLimitResult.timeToReset})\n          });\n          return;\n        }\n      }\n\n      var handler = self.server.publish_handlers[msg.name];\n\n      self._startSubscription(handler, msg.id, msg.params, msg.name);\n\n      // cleaning cached unblock\n      self.cachedUnblock = null;\n    },\n\n    unsub: function (msg) {\n      var self = this;\n\n      self._stopSubscription(msg.id);\n    },\n\n    method: function (msg, unblock) {\n      var self = this;\n\n      // reject malformed messages\n      // For now, we silently ignore unknown attributes,\n      // for forwards compatibility.\n      if (typeof (msg.id) !== \"string\" ||\n          typeof (msg.method) !== \"string\" ||\n          (('params' in msg) && !(msg.params instanceof Array)) ||\n          (('randomSeed' in msg) && (typeof msg.randomSeed !== \"string\"))) {\n        self.sendError(\"Malformed method invocation\", msg);\n        return;\n      }\n\n      var randomSeed = msg.randomSeed || null;\n\n      // set up to mark the method as satisfied once all observers\n      // (and subscriptions) have reacted to any writes that were\n      // done.\n      var fence = new DDPServer._WriteFence;\n      fence.onAllCommitted(function () {\n        // Retire the fence so that future writes are allowed.\n        // This means that callbacks like timers are free to use\n        // the fence, and if they fire before it's armed (for\n        // example, because the method waits for them) their\n        // writes will be included in the fence.\n        fence.retire();\n        self.send({\n          msg: 'updated', methods: [msg.id]});\n      });\n\n      // find the handler\n      var handler = self.server.method_handlers[msg.method];\n      if (!handler) {\n        self.send({\n          msg: 'result', id: msg.id,\n          error: new Meteor.Error(404, `Method '${msg.method}' not found`)});\n        fence.arm();\n        return;\n      }\n\n      var setUserId = function(userId) {\n        self._setUserId(userId);\n      };\n\n      var invocation = new DDPCommon.MethodInvocation({\n        isSimulation: false,\n        userId: self.userId,\n        setUserId: setUserId,\n        unblock: unblock,\n        connection: self.connectionHandle,\n        randomSeed: randomSeed\n      });\n\n      const promise = new Promise((resolve, reject) => {\n        // XXX It'd be better if we could hook into method handlers better but\n        // for now, we need to check if the ddp-rate-limiter exists since we\n        // have a weak requirement for the ddp-rate-limiter package to be added\n        // to our application.\n        if (Package['ddp-rate-limiter']) {\n          var DDPRateLimiter = Package['ddp-rate-limiter'].DDPRateLimiter;\n          var rateLimiterInput = {\n            userId: self.userId,\n            clientAddress: self.connectionHandle.clientAddress,\n            type: \"method\",\n            name: msg.method,\n            connectionId: self.id\n          };\n          DDPRateLimiter._increment(rateLimiterInput);\n          var rateLimitResult = DDPRateLimiter._check(rateLimiterInput)\n          if (!rateLimitResult.allowed) {\n            reject(new Meteor.Error(\n              \"too-many-requests\",\n              DDPRateLimiter.getErrorMessage(rateLimitResult),\n              {timeToReset: rateLimitResult.timeToReset}\n            ));\n            return;\n          }\n        }\n\n        resolve(DDPServer._CurrentWriteFence.withValue(\n          fence,\n          () => DDP._CurrentMethodInvocation.withValue(\n            invocation,\n            () => maybeAuditArgumentChecks(\n              handler, invocation, msg.params,\n              \"call to '\" + msg.method + \"'\"\n            )\n          )\n        ));\n      });\n\n      function finish() {\n        fence.arm();\n        unblock();\n      }\n\n      const payload = {\n        msg: \"result\",\n        id: msg.id\n      };\n\n      promise.then((result) => {\n        finish();\n        if (result !== undefined) {\n          payload.result = result;\n        }\n        self.send(payload);\n      }, (exception) => {\n        finish();\n        payload.error = wrapInternalException(\n          exception,\n          `while invoking method '${msg.method}'`\n        );\n        self.send(payload);\n      });\n    }\n  },\n\n  _eachSub: function (f) {\n    var self = this;\n    self._namedSubs.forEach(f);\n    self._universalSubs.forEach(f);\n  },\n\n  _diffCollectionViews: function (beforeCVs) {\n    var self = this;\n    DiffSequence.diffMaps(beforeCVs, self.collectionViews, {\n      both: function (collectionName, leftValue, rightValue) {\n        rightValue.diff(leftValue);\n      },\n      rightOnly: function (collectionName, rightValue) {\n        rightValue.documents.forEach(function (docView, id) {\n          self.sendAdded(collectionName, id, docView.getFields());\n        });\n      },\n      leftOnly: function (collectionName, leftValue) {\n        leftValue.documents.forEach(function (doc, id) {\n          self.sendRemoved(collectionName, id);\n        });\n      }\n    });\n  },\n\n  // Sets the current user id in all appropriate contexts and reruns\n  // all subscriptions\n  _setUserId: function(userId) {\n    var self = this;\n\n    if (userId !== null && typeof userId !== \"string\")\n      throw new Error(\"setUserId must be called on string or null, not \" +\n                      typeof userId);\n\n    // Prevent newly-created universal subscriptions from being added to our\n    // session; they will be found below when we call startUniversalSubs.\n    //\n    // (We don't have to worry about named subscriptions, because we only add\n    // them when we process a 'sub' message. We are currently processing a\n    // 'method' message, and the method did not unblock, because it is illegal\n    // to call setUserId after unblock. Thus we cannot be concurrently adding a\n    // new named subscription.)\n    self._dontStartNewUniversalSubs = true;\n\n    // Prevent current subs from updating our collectionViews and call their\n    // stop callbacks. This may yield.\n    self._eachSub(function (sub) {\n      sub._deactivate();\n    });\n\n    // All subs should now be deactivated. Stop sending messages to the client,\n    // save the state of the published collections, reset to an empty view, and\n    // update the userId.\n    self._isSending = false;\n    var beforeCVs = self.collectionViews;\n    self.collectionViews = new Map();\n    self.userId = userId;\n\n    // _setUserId is normally called from a Meteor method with\n    // DDP._CurrentMethodInvocation set. But DDP._CurrentMethodInvocation is not\n    // expected to be set inside a publish function, so we temporary unset it.\n    // Inside a publish function DDP._CurrentPublicationInvocation is set.\n    DDP._CurrentMethodInvocation.withValue(undefined, function () {\n      // Save the old named subs, and reset to having no subscriptions.\n      var oldNamedSubs = self._namedSubs;\n      self._namedSubs = new Map();\n      self._universalSubs = [];\n\n      oldNamedSubs.forEach(function (sub, subscriptionId) {\n        var newSub = sub._recreate();\n        self._namedSubs.set(subscriptionId, newSub);\n        // nb: if the handler throws or calls this.error(), it will in fact\n        // immediately send its 'nosub'. This is OK, though.\n        newSub._runHandler();\n      });\n\n      // Allow newly-created universal subs to be started on our connection in\n      // parallel with the ones we're spinning up here, and spin up universal\n      // subs.\n      self._dontStartNewUniversalSubs = false;\n      self.startUniversalSubs();\n    });\n\n    // Start sending messages again, beginning with the diff from the previous\n    // state of the world to the current state. No yields are allowed during\n    // this diff, so that other changes cannot interleave.\n    Meteor._noYieldsAllowed(function () {\n      self._isSending = true;\n      self._diffCollectionViews(beforeCVs);\n      if (!_.isEmpty(self._pendingReady)) {\n        self.sendReady(self._pendingReady);\n        self._pendingReady = [];\n      }\n    });\n  },\n\n  _startSubscription: function (handler, subId, params, name) {\n    var self = this;\n\n    var sub = new Subscription(\n      self, handler, subId, params, name);\n\n    let unblockHander = self.cachedUnblock;\n    // _startSubscription may call from a lot places\n    // so cachedUnblock might be null in somecases\n    // assign the cachedUnblock\n    sub.unblock = unblockHander || (() => {});\n\n    if (subId)\n      self._namedSubs.set(subId, sub);\n    else\n      self._universalSubs.push(sub);\n\n    sub._runHandler();\n  },\n\n  // tear down specified subscription\n  _stopSubscription: function (subId, error) {\n    var self = this;\n\n    var subName = null;\n    if (subId) {\n      var maybeSub = self._namedSubs.get(subId);\n      if (maybeSub) {\n        subName = maybeSub._name;\n        maybeSub._removeAllDocuments();\n        maybeSub._deactivate();\n        self._namedSubs.delete(subId);\n      }\n    }\n\n    var response = {msg: 'nosub', id: subId};\n\n    if (error) {\n      response.error = wrapInternalException(\n        error,\n        subName ? (\"from sub \" + subName + \" id \" + subId)\n          : (\"from sub id \" + subId));\n    }\n\n    self.send(response);\n  },\n\n  // tear down all subscriptions. Note that this does NOT send removed or nosub\n  // messages, since we assume the client is gone.\n  _deactivateAllSubscriptions: function () {\n    var self = this;\n\n    self._namedSubs.forEach(function (sub, id) {\n      sub._deactivate();\n    });\n    self._namedSubs = new Map();\n\n    self._universalSubs.forEach(function (sub) {\n      sub._deactivate();\n    });\n    self._universalSubs = [];\n  },\n\n  // Determine the remote client's IP address, based on the\n  // HTTP_FORWARDED_COUNT environment variable representing how many\n  // proxies the server is behind.\n  _clientAddress: function () {\n    var self = this;\n\n    // For the reported client address for a connection to be correct,\n    // the developer must set the HTTP_FORWARDED_COUNT environment\n    // variable to an integer representing the number of hops they\n    // expect in the `x-forwarded-for` header. E.g., set to \"1\" if the\n    // server is behind one proxy.\n    //\n    // This could be computed once at startup instead of every time.\n    var httpForwardedCount = parseInt(process.env['HTTP_FORWARDED_COUNT']) || 0;\n\n    if (httpForwardedCount === 0)\n      return self.socket.remoteAddress;\n\n    var forwardedFor = self.socket.headers[\"x-forwarded-for\"];\n    if (! _.isString(forwardedFor))\n      return null;\n    forwardedFor = forwardedFor.trim().split(/\\s*,\\s*/);\n\n    // Typically the first value in the `x-forwarded-for` header is\n    // the original IP address of the client connecting to the first\n    // proxy.  However, the end user can easily spoof the header, in\n    // which case the first value(s) will be the fake IP address from\n    // the user pretending to be a proxy reporting the original IP\n    // address value.  By counting HTTP_FORWARDED_COUNT back from the\n    // end of the list, we ensure that we get the IP address being\n    // reported by *our* first proxy.\n\n    if (httpForwardedCount < 0 || httpForwardedCount > forwardedFor.length)\n      return null;\n\n    return forwardedFor[forwardedFor.length - httpForwardedCount];\n  }\n});\n\n/******************************************************************************/\n/* Subscription                                                               */\n/******************************************************************************/\n\n// ctor for a sub handle: the input to each publish function\n\n// Instance name is this because it's usually referred to as this inside a\n// publish\n/**\n * @summary The server's side of a subscription\n * @class Subscription\n * @instanceName this\n * @showInstanceName true\n */\nvar Subscription = function (\n    session, handler, subscriptionId, params, name) {\n  var self = this;\n  self._session = session; // type is Session\n\n  /**\n   * @summary Access inside the publish function. The incoming [connection](#meteor_onconnection) for this subscription.\n   * @locus Server\n   * @name  connection\n   * @memberOf Subscription\n   * @instance\n   */\n  self.connection = session.connectionHandle; // public API object\n\n  self._handler = handler;\n\n  // my subscription ID (generated by client, undefined for universal subs).\n  self._subscriptionId = subscriptionId;\n  // undefined for universal subs\n  self._name = name;\n\n  self._params = params || [];\n\n  // Only named subscriptions have IDs, but we need some sort of string\n  // internally to keep track of all subscriptions inside\n  // SessionDocumentViews. We use this subscriptionHandle for that.\n  if (self._subscriptionId) {\n    self._subscriptionHandle = 'N' + self._subscriptionId;\n  } else {\n    self._subscriptionHandle = 'U' + Random.id();\n  }\n\n  // has _deactivate been called?\n  self._deactivated = false;\n\n  // stop callbacks to g/c this sub.  called w/ zero arguments.\n  self._stopCallbacks = [];\n\n  // the set of (collection, documentid) that this subscription has\n  // an opinion about\n  self._documents = new Map();\n\n  // remember if we are ready.\n  self._ready = false;\n\n  // Part of the public API: the user of this sub.\n\n  /**\n   * @summary Access inside the publish function. The id of the logged-in user, or `null` if no user is logged in.\n   * @locus Server\n   * @memberOf Subscription\n   * @name  userId\n   * @instance\n   */\n  self.userId = session.userId;\n\n  // For now, the id filter is going to default to\n  // the to/from DDP methods on MongoID, to\n  // specifically deal with mongo/minimongo ObjectIds.\n\n  // Later, you will be able to make this be \"raw\"\n  // if you want to publish a collection that you know\n  // just has strings for keys and no funny business, to\n  // a ddp consumer that isn't minimongo\n\n  self._idFilter = {\n    idStringify: MongoID.idStringify,\n    idParse: MongoID.idParse\n  };\n\n  Package['facts-base'] && Package['facts-base'].Facts.incrementServerFact(\n    \"livedata\", \"subscriptions\", 1);\n};\n\nObject.assign(Subscription.prototype, {\n  _runHandler: function() {\n    // XXX should we unblock() here? Either before running the publish\n    // function, or before running _publishCursor.\n    //\n    // Right now, each publish function blocks all future publishes and\n    // methods waiting on data from Mongo (or whatever else the function\n    // blocks on). This probably slows page load in common cases.\n\n    if (!this.unblock) {\n      this.unblock = () => {};\n    }\n\n    const self = this;\n    let resultOrThenable = null;\n    try {\n      resultOrThenable = DDP._CurrentPublicationInvocation.withValue(self, () =>\n        maybeAuditArgumentChecks(\n          self._handler,\n          self,\n          EJSON.clone(self._params),\n          // It's OK that this would look weird for universal subscriptions,\n          // because they have no arguments so there can never be an\n          // audit-argument-checks failure.\n          \"publisher '\" + self._name + \"'\"\n        )\n      );\n    } catch (e) {\n      self.error(e);\n      return;\n    }\n\n    // Did the handler call this.error or this.stop?\n    if (self._isDeactivated()) return;\n\n    // Both conventional and async publish handler functions are supported.\n    // If an object is returned with a then() function, it is either a promise\n    // or thenable and will be resolved asynchronously.\n    const isThenable =\n      resultOrThenable && typeof resultOrThenable.then === 'function';\n    if (isThenable) {\n      Promise.resolve(resultOrThenable).then(\n        (...args) => self._publishHandlerResult.bind(self)(...args),\n        e => self.error(e)\n      );\n    } else {\n      self._publishHandlerResult(resultOrThenable);\n    }\n  },\n\n  _publishHandlerResult: function (res) {\n    // SPECIAL CASE: Instead of writing their own callbacks that invoke\n    // this.added/changed/ready/etc, the user can just return a collection\n    // cursor or array of cursors from the publish function; we call their\n    // _publishCursor method which starts observing the cursor and publishes the\n    // results. Note that _publishCursor does NOT call ready().\n    //\n    // XXX This uses an undocumented interface which only the Mongo cursor\n    // interface publishes. Should we make this interface public and encourage\n    // users to implement it themselves? Arguably, it's unnecessary; users can\n    // already write their own functions like\n    //   var publishMyReactiveThingy = function (name, handler) {\n    //     Meteor.publish(name, function () {\n    //       var reactiveThingy = handler();\n    //       reactiveThingy.publishMe();\n    //     });\n    //   };\n\n    var self = this;\n    var isCursor = function (c) {\n      return c && c._publishCursor;\n    };\n    if (isCursor(res)) {\n      try {\n        res._publishCursor(self);\n      } catch (e) {\n        self.error(e);\n        return;\n      }\n      // _publishCursor only returns after the initial added callbacks have run.\n      // mark subscription as ready.\n      self.ready();\n    } else if (_.isArray(res)) {\n      // check all the elements are cursors\n      if (! _.all(res, isCursor)) {\n        self.error(new Error(\"Publish function returned an array of non-Cursors\"));\n        return;\n      }\n      // find duplicate collection names\n      // XXX we should support overlapping cursors, but that would require the\n      // merge box to allow overlap within a subscription\n      var collectionNames = {};\n      for (var i = 0; i < res.length; ++i) {\n        var collectionName = res[i]._getCollectionName();\n        if (_.has(collectionNames, collectionName)) {\n          self.error(new Error(\n            \"Publish function returned multiple cursors for collection \" +\n              collectionName));\n          return;\n        }\n        collectionNames[collectionName] = true;\n      };\n\n      try {\n        _.each(res, function (cur) {\n          cur._publishCursor(self);\n        });\n      } catch (e) {\n        self.error(e);\n        return;\n      }\n      self.ready();\n    } else if (res) {\n      // truthy values other than cursors or arrays are probably a\n      // user mistake (possible returning a Mongo document via, say,\n      // `coll.findOne()`).\n      self.error(new Error(\"Publish function can only return a Cursor or \"\n                           + \"an array of Cursors\"));\n    }\n  },\n\n  // This calls all stop callbacks and prevents the handler from updating any\n  // SessionCollectionViews further. It's used when the user unsubscribes or\n  // disconnects, as well as during setUserId re-runs. It does *NOT* send\n  // removed messages for the published objects; if that is necessary, call\n  // _removeAllDocuments first.\n  _deactivate: function() {\n    var self = this;\n    if (self._deactivated)\n      return;\n    self._deactivated = true;\n    self._callStopCallbacks();\n    Package['facts-base'] && Package['facts-base'].Facts.incrementServerFact(\n      \"livedata\", \"subscriptions\", -1);\n  },\n\n  _callStopCallbacks: function () {\n    var self = this;\n    // tell listeners, so they can clean up\n    var callbacks = self._stopCallbacks;\n    self._stopCallbacks = [];\n    _.each(callbacks, function (callback) {\n      callback();\n    });\n  },\n\n  // Send remove messages for every document.\n  _removeAllDocuments: function () {\n    var self = this;\n    Meteor._noYieldsAllowed(function () {\n      self._documents.forEach(function (collectionDocs, collectionName) {\n        collectionDocs.forEach(function (strId) {\n          self.removed(collectionName, self._idFilter.idParse(strId));\n        });\n      });\n    });\n  },\n\n  // Returns a new Subscription for the same session with the same\n  // initial creation parameters. This isn't a clone: it doesn't have\n  // the same _documents cache, stopped state or callbacks; may have a\n  // different _subscriptionHandle, and gets its userId from the\n  // session, not from this object.\n  _recreate: function () {\n    var self = this;\n    return new Subscription(\n      self._session, self._handler, self._subscriptionId, self._params,\n      self._name);\n  },\n\n  /**\n   * @summary Call inside the publish function.  Stops this client's subscription, triggering a call on the client to the `onStop` callback passed to [`Meteor.subscribe`](#meteor_subscribe), if any. If `error` is not a [`Meteor.Error`](#meteor_error), it will be [sanitized](#meteor_error).\n   * @locus Server\n   * @param {Error} error The error to pass to the client.\n   * @instance\n   * @memberOf Subscription\n   */\n  error: function (error) {\n    var self = this;\n    if (self._isDeactivated())\n      return;\n    self._session._stopSubscription(self._subscriptionId, error);\n  },\n\n  // Note that while our DDP client will notice that you've called stop() on the\n  // server (and clean up its _subscriptions table) we don't actually provide a\n  // mechanism for an app to notice this (the subscribe onError callback only\n  // triggers if there is an error).\n\n  /**\n   * @summary Call inside the publish function.  Stops this client's subscription and invokes the client's `onStop` callback with no error.\n   * @locus Server\n   * @instance\n   * @memberOf Subscription\n   */\n  stop: function () {\n    var self = this;\n    if (self._isDeactivated())\n      return;\n    self._session._stopSubscription(self._subscriptionId);\n  },\n\n  /**\n   * @summary Call inside the publish function.  Registers a callback function to run when the subscription is stopped.\n   * @locus Server\n   * @memberOf Subscription\n   * @instance\n   * @param {Function} func The callback function\n   */\n  onStop: function (callback) {\n    var self = this;\n    callback = Meteor.bindEnvironment(callback, 'onStop callback', self);\n    if (self._isDeactivated())\n      callback();\n    else\n      self._stopCallbacks.push(callback);\n  },\n\n  // This returns true if the sub has been deactivated, *OR* if the session was\n  // destroyed but the deferred call to _deactivateAllSubscriptions hasn't\n  // happened yet.\n  _isDeactivated: function () {\n    var self = this;\n    return self._deactivated || self._session.inQueue === null;\n  },\n\n  /**\n   * @summary Call inside the publish function.  Informs the subscriber that a document has been added to the record set.\n   * @locus Server\n   * @memberOf Subscription\n   * @instance\n   * @param {String} collection The name of the collection that contains the new document.\n   * @param {String} id The new document's ID.\n   * @param {Object} fields The fields in the new document.  If `_id` is present it is ignored.\n   */\n  added: function (collectionName, id, fields) {\n    var self = this;\n    if (self._isDeactivated())\n      return;\n    id = self._idFilter.idStringify(id);\n    let ids = self._documents.get(collectionName);\n    if (ids == null) {\n      ids = new Set();\n      self._documents.set(collectionName, ids);\n    }\n    ids.add(id);\n    self._session.added(self._subscriptionHandle, collectionName, id, fields);\n  },\n\n  /**\n   * @summary Call inside the publish function.  Informs the subscriber that a document in the record set has been modified.\n   * @locus Server\n   * @memberOf Subscription\n   * @instance\n   * @param {String} collection The name of the collection that contains the changed document.\n   * @param {String} id The changed document's ID.\n   * @param {Object} fields The fields in the document that have changed, together with their new values.  If a field is not present in `fields` it was left unchanged; if it is present in `fields` and has a value of `undefined` it was removed from the document.  If `_id` is present it is ignored.\n   */\n  changed: function (collectionName, id, fields) {\n    var self = this;\n    if (self._isDeactivated())\n      return;\n    id = self._idFilter.idStringify(id);\n    self._session.changed(self._subscriptionHandle, collectionName, id, fields);\n  },\n\n  /**\n   * @summary Call inside the publish function.  Informs the subscriber that a document has been removed from the record set.\n   * @locus Server\n   * @memberOf Subscription\n   * @instance\n   * @param {String} collection The name of the collection that the document has been removed from.\n   * @param {String} id The ID of the document that has been removed.\n   */\n  removed: function (collectionName, id) {\n    var self = this;\n    if (self._isDeactivated())\n      return;\n    id = self._idFilter.idStringify(id);\n    // We don't bother to delete sets of things in a collection if the\n    // collection is empty.  It could break _removeAllDocuments.\n    self._documents.get(collectionName).delete(id);\n    self._session.removed(self._subscriptionHandle, collectionName, id);\n  },\n\n  /**\n   * @summary Call inside the publish function.  Informs the subscriber that an initial, complete snapshot of the record set has been sent.  This will trigger a call on the client to the `onReady` callback passed to  [`Meteor.subscribe`](#meteor_subscribe), if any.\n   * @locus Server\n   * @memberOf Subscription\n   * @instance\n   */\n  ready: function () {\n    var self = this;\n    if (self._isDeactivated())\n      return;\n    if (!self._subscriptionId)\n      return;  // unnecessary but ignored for universal sub\n    if (!self._ready) {\n      self._session.sendReady([self._subscriptionId]);\n      self._ready = true;\n    }\n  }\n});\n\n/******************************************************************************/\n/* Server                                                                     */\n/******************************************************************************/\n\nServer = function (options) {\n  var self = this;\n\n  // The default heartbeat interval is 30 seconds on the server and 35\n  // seconds on the client.  Since the client doesn't need to send a\n  // ping as long as it is receiving pings, this means that pings\n  // normally go from the server to the client.\n  //\n  // Note: Troposphere depends on the ability to mutate\n  // Meteor.server.options.heartbeatTimeout! This is a hack, but it's life.\n  self.options = _.defaults(options || {}, {\n    heartbeatInterval: 15000,\n    heartbeatTimeout: 15000,\n    // For testing, allow responding to pings to be disabled.\n    respondToPings: true\n  });\n\n  // Map of callbacks to call when a new connection comes in to the\n  // server and completes DDP version negotiation. Use an object instead\n  // of an array so we can safely remove one from the list while\n  // iterating over it.\n  self.onConnectionHook = new Hook({\n    debugPrintExceptions: \"onConnection callback\"\n  });\n\n  // Map of callbacks to call when a new message comes in.\n  self.onMessageHook = new Hook({\n    debugPrintExceptions: \"onMessage callback\"\n  });\n\n  self.publish_handlers = {};\n  self.universal_publish_handlers = [];\n\n  self.method_handlers = {};\n\n  self.sessions = new Map(); // map from id to session\n\n  self.stream_server = new StreamServer;\n\n  self.stream_server.register(function (socket) {\n    // socket implements the SockJSConnection interface\n    socket._meteorSession = null;\n\n    var sendError = function (reason, offendingMessage) {\n      var msg = {msg: 'error', reason: reason};\n      if (offendingMessage)\n        msg.offendingMessage = offendingMessage;\n      socket.send(DDPCommon.stringifyDDP(msg));\n    };\n\n    socket.on('data', function (raw_msg) {\n      if (Meteor._printReceivedDDP) {\n        Meteor._debug(\"Received DDP\", raw_msg);\n      }\n      try {\n        try {\n          var msg = DDPCommon.parseDDP(raw_msg);\n        } catch (err) {\n          sendError('Parse error');\n          return;\n        }\n        if (msg === null || !msg.msg) {\n          sendError('Bad request', msg);\n          return;\n        }\n\n        if (msg.msg === 'connect') {\n          if (socket._meteorSession) {\n            sendError(\"Already connected\", msg);\n            return;\n          }\n          Fiber(function () {\n            self._handleConnect(socket, msg);\n          }).run();\n          return;\n        }\n\n        if (!socket._meteorSession) {\n          sendError('Must connect first', msg);\n          return;\n        }\n        socket._meteorSession.processMessage(msg);\n      } catch (e) {\n        // XXX print stack nicely\n        Meteor._debug(\"Internal exception while processing message\", msg, e);\n      }\n    });\n\n    socket.on('close', function () {\n      if (socket._meteorSession) {\n        Fiber(function () {\n          socket._meteorSession.close();\n        }).run();\n      }\n    });\n  });\n};\n\nObject.assign(Server.prototype, {\n\n  /**\n   * @summary Register a callback to be called when a new DDP connection is made to the server.\n   * @locus Server\n   * @param {function} callback The function to call when a new DDP connection is established.\n   * @memberOf Meteor\n   * @importFromPackage meteor\n   */\n  onConnection: function (fn) {\n    var self = this;\n    return self.onConnectionHook.register(fn);\n  },\n\n  /**\n   * @summary Register a callback to be called when a new DDP message is received.\n   * @locus Server\n   * @param {function} callback The function to call when a new DDP message is received.\n   * @memberOf Meteor\n   * @importFromPackage meteor\n   */\n  onMessage: function (fn) {\n    var self = this;\n    return self.onMessageHook.register(fn);\n  },\n\n  _handleConnect: function (socket, msg) {\n    var self = this;\n\n    // The connect message must specify a version and an array of supported\n    // versions, and it must claim to support what it is proposing.\n    if (!(typeof (msg.version) === 'string' &&\n          _.isArray(msg.support) &&\n          _.all(msg.support, _.isString) &&\n          _.contains(msg.support, msg.version))) {\n      socket.send(DDPCommon.stringifyDDP({msg: 'failed',\n                                version: DDPCommon.SUPPORTED_DDP_VERSIONS[0]}));\n      socket.close();\n      return;\n    }\n\n    // In the future, handle session resumption: something like:\n    //  socket._meteorSession = self.sessions[msg.session]\n    var version = calculateVersion(msg.support, DDPCommon.SUPPORTED_DDP_VERSIONS);\n\n    if (msg.version !== version) {\n      // The best version to use (according to the client's stated preferences)\n      // is not the one the client is trying to use. Inform them about the best\n      // version to use.\n      socket.send(DDPCommon.stringifyDDP({msg: 'failed', version: version}));\n      socket.close();\n      return;\n    }\n\n    // Yay, version matches! Create a new session.\n    // Note: Troposphere depends on the ability to mutate\n    // Meteor.server.options.heartbeatTimeout! This is a hack, but it's life.\n    socket._meteorSession = new Session(self, version, socket, self.options);\n    self.sessions.set(socket._meteorSession.id, socket._meteorSession);\n    self.onConnectionHook.each(function (callback) {\n      if (socket._meteorSession)\n        callback(socket._meteorSession.connectionHandle);\n      return true;\n    });\n  },\n  /**\n   * Register a publish handler function.\n   *\n   * @param name {String} identifier for query\n   * @param handler {Function} publish handler\n   * @param options {Object}\n   *\n   * Server will call handler function on each new subscription,\n   * either when receiving DDP sub message for a named subscription, or on\n   * DDP connect for a universal subscription.\n   *\n   * If name is null, this will be a subscription that is\n   * automatically established and permanently on for all connected\n   * client, instead of a subscription that can be turned on and off\n   * with subscribe().\n   *\n   * options to contain:\n   *  - (mostly internal) is_auto: true if generated automatically\n   *    from an autopublish hook. this is for cosmetic purposes only\n   *    (it lets us determine whether to print a warning suggesting\n   *    that you turn off autopublish.)\n   */\n\n  /**\n   * @summary Publish a record set.\n   * @memberOf Meteor\n   * @importFromPackage meteor\n   * @locus Server\n   * @param {String|Object} name If String, name of the record set.  If Object, publications Dictionary of publish functions by name.  If `null`, the set has no name, and the record set is automatically sent to all connected clients.\n   * @param {Function} func Function called on the server each time a client subscribes.  Inside the function, `this` is the publish handler object, described below.  If the client passed arguments to `subscribe`, the function is called with the same arguments.\n   */\n  publish: function (name, handler, options) {\n    var self = this;\n\n    if (! _.isObject(name)) {\n      options = options || {};\n\n      if (name && name in self.publish_handlers) {\n        Meteor._debug(\"Ignoring duplicate publish named '\" + name + \"'\");\n        return;\n      }\n\n      if (Package.autopublish && !options.is_auto) {\n        // They have autopublish on, yet they're trying to manually\n        // picking stuff to publish. They probably should turn off\n        // autopublish. (This check isn't perfect -- if you create a\n        // publish before you turn on autopublish, it won't catch\n        // it. But this will definitely handle the simple case where\n        // you've added the autopublish package to your app, and are\n        // calling publish from your app code.)\n        if (!self.warned_about_autopublish) {\n          self.warned_about_autopublish = true;\n          Meteor._debug(\n    \"** You've set up some data subscriptions with Meteor.publish(), but\\n\" +\n    \"** you still have autopublish turned on. Because autopublish is still\\n\" +\n    \"** on, your Meteor.publish() calls won't have much effect. All data\\n\" +\n    \"** will still be sent to all clients.\\n\" +\n    \"**\\n\" +\n    \"** Turn off autopublish by removing the autopublish package:\\n\" +\n    \"**\\n\" +\n    \"**   $ meteor remove autopublish\\n\" +\n    \"**\\n\" +\n    \"** .. and make sure you have Meteor.publish() and Meteor.subscribe() calls\\n\" +\n    \"** for each collection that you want clients to see.\\n\");\n        }\n      }\n\n      if (name)\n        self.publish_handlers[name] = handler;\n      else {\n        self.universal_publish_handlers.push(handler);\n        // Spin up the new publisher on any existing session too. Run each\n        // session's subscription in a new Fiber, so that there's no change for\n        // self.sessions to change while we're running this loop.\n        self.sessions.forEach(function (session) {\n          if (!session._dontStartNewUniversalSubs) {\n            Fiber(function() {\n              session._startSubscription(handler);\n            }).run();\n          }\n        });\n      }\n    }\n    else{\n      _.each(name, function(value, key) {\n        self.publish(key, value, {});\n      });\n    }\n  },\n\n  _removeSession: function (session) {\n    var self = this;\n    self.sessions.delete(session.id);\n  },\n\n  /**\n   * @summary Defines functions that can be invoked over the network by clients.\n   * @locus Anywhere\n   * @param {Object} methods Dictionary whose keys are method names and values are functions.\n   * @memberOf Meteor\n   * @importFromPackage meteor\n   */\n  methods: function (methods) {\n    var self = this;\n    _.each(methods, function (func, name) {\n      if (typeof func !== 'function')\n        throw new Error(\"Method '\" + name + \"' must be a function\");\n      if (self.method_handlers[name])\n        throw new Error(\"A method named '\" + name + \"' is already defined\");\n      self.method_handlers[name] = func;\n    });\n  },\n\n  call: function (name, ...args) {\n    if (args.length && typeof args[args.length - 1] === \"function\") {\n      // If it's a function, the last argument is the result callback, not\n      // a parameter to the remote method.\n      var callback = args.pop();\n    }\n\n    return this.apply(name, args, callback);\n  },\n\n  // A version of the call method that always returns a Promise.\n  callAsync: function (name, ...args) {\n    return this.applyAsync(name, args);\n  },\n\n  apply: function (name, args, options, callback) {\n    // We were passed 3 arguments. They may be either (name, args, options)\n    // or (name, args, callback)\n    if (! callback && typeof options === 'function') {\n      callback = options;\n      options = {};\n    } else {\n      options = options || {};\n    }\n\n    const promise = this.applyAsync(name, args, options);\n\n    // Return the result in whichever way the caller asked for it. Note that we\n    // do NOT block on the write fence in an analogous way to how the client\n    // blocks on the relevant data being visible, so you are NOT guaranteed that\n    // cursor observe callbacks have fired when your callback is invoked. (We\n    // can change this if there's a real use case.)\n    if (callback) {\n      promise.then(\n        result => callback(undefined, result),\n        exception => callback(exception)\n      );\n    } else {\n      return promise.await();\n    }\n  },\n\n  // @param options {Optional Object}\n  applyAsync: function (name, args, options) {\n    // Run the handler\n    var handler = this.method_handlers[name];\n    if (! handler) {\n      return Promise.reject(\n        new Meteor.Error(404, `Method '${name}' not found`)\n      );\n    }\n\n    // If this is a method call from within another method or publish function,\n    // get the user state from the outer method or publish function, otherwise\n    // don't allow setUserId to be called\n    var userId = null;\n    var setUserId = function() {\n      throw new Error(\"Can't call setUserId on a server initiated method call\");\n    };\n    var connection = null;\n    var currentMethodInvocation = DDP._CurrentMethodInvocation.get();\n    var currentPublicationInvocation = DDP._CurrentPublicationInvocation.get();\n    var randomSeed = null;\n    if (currentMethodInvocation) {\n      userId = currentMethodInvocation.userId;\n      setUserId = function(userId) {\n        currentMethodInvocation.setUserId(userId);\n      };\n      connection = currentMethodInvocation.connection;\n      randomSeed = DDPCommon.makeRpcSeed(currentMethodInvocation, name);\n    } else if (currentPublicationInvocation) {\n      userId = currentPublicationInvocation.userId;\n      setUserId = function(userId) {\n        currentPublicationInvocation._session._setUserId(userId);\n      };\n      connection = currentPublicationInvocation.connection;\n    }\n\n    var invocation = new DDPCommon.MethodInvocation({\n      isSimulation: false,\n      userId,\n      setUserId,\n      connection,\n      randomSeed\n    });\n\n    return new Promise(resolve => resolve(\n      DDP._CurrentMethodInvocation.withValue(\n        invocation,\n        () => maybeAuditArgumentChecks(\n          handler, invocation, EJSON.clone(args),\n          \"internal call to '\" + name + \"'\"\n        )\n      )\n    )).then(EJSON.clone);\n  },\n\n  _urlForSession: function (sessionId) {\n    var self = this;\n    var session = self.sessions.get(sessionId);\n    if (session)\n      return session._socketUrl;\n    else\n      return null;\n  }\n});\n\nvar calculateVersion = function (clientSupportedVersions,\n                                 serverSupportedVersions) {\n  var correctVersion = _.find(clientSupportedVersions, function (version) {\n    return _.contains(serverSupportedVersions, version);\n  });\n  if (!correctVersion) {\n    correctVersion = serverSupportedVersions[0];\n  }\n  return correctVersion;\n};\n\nDDPServer._calculateVersion = calculateVersion;\n\n\n// \"blind\" exceptions other than those that were deliberately thrown to signal\n// errors to the client\nvar wrapInternalException = function (exception, context) {\n  if (!exception) return exception;\n\n  // To allow packages to throw errors intended for the client but not have to\n  // depend on the Meteor.Error class, `isClientSafe` can be set to true on any\n  // error before it is thrown.\n  if (exception.isClientSafe) {\n    if (!(exception instanceof Meteor.Error)) {\n      const originalMessage = exception.message;\n      exception = new Meteor.Error(exception.error, exception.reason, exception.details);\n      exception.message = originalMessage;\n    }\n    return exception;\n  }\n\n  // Tests can set the '_expectedByTest' flag on an exception so it won't go to\n  // the server log.\n  if (!exception._expectedByTest) {\n    Meteor._debug(\"Exception \" + context, exception.stack);\n    if (exception.sanitizedError) {\n      Meteor._debug(\"Sanitized and reported to the client as:\", exception.sanitizedError);\n      Meteor._debug();\n    }\n  }\n\n  // Did the error contain more details that could have been useful if caught in\n  // server code (or if thrown from non-client-originated code), but also\n  // provided a \"sanitized\" version with more context than 500 Internal server\n  // error? Use that.\n  if (exception.sanitizedError) {\n    if (exception.sanitizedError.isClientSafe)\n      return exception.sanitizedError;\n    Meteor._debug(\"Exception \" + context + \" provides a sanitizedError that \" +\n                  \"does not have isClientSafe property set; ignoring\");\n  }\n\n  return new Meteor.Error(500, \"Internal server error\");\n};\n\n\n// Audit argument checks, if the audit-argument-checks package exists (it is a\n// weak dependency of this package).\nvar maybeAuditArgumentChecks = function (f, context, args, description) {\n  args = args || [];\n  if (Package['audit-argument-checks']) {\n    return Match._failIfArgumentsAreNotAllChecked(\n      f, context, args, description);\n  }\n  return f.apply(context, args);\n};\n","var Future = Npm.require('fibers/future');\n\n// A write fence collects a group of writes, and provides a callback\n// when all of the writes are fully committed and propagated (all\n// observers have been notified of the write and acknowledged it.)\n//\nDDPServer._WriteFence = function () {\n  var self = this;\n\n  self.armed = false;\n  self.fired = false;\n  self.retired = false;\n  self.outstanding_writes = 0;\n  self.before_fire_callbacks = [];\n  self.completion_callbacks = [];\n};\n\n// The current write fence. When there is a current write fence, code\n// that writes to databases should register their writes with it using\n// beginWrite().\n//\nDDPServer._CurrentWriteFence = new Meteor.EnvironmentVariable;\n\n_.extend(DDPServer._WriteFence.prototype, {\n  // Start tracking a write, and return an object to represent it. The\n  // object has a single method, committed(). This method should be\n  // called when the write is fully committed and propagated. You can\n  // continue to add writes to the WriteFence up until it is triggered\n  // (calls its callbacks because all writes have committed.)\n  beginWrite: function () {\n    var self = this;\n\n    if (self.retired)\n      return { committed: function () {} };\n\n    if (self.fired)\n      throw new Error(\"fence has already activated -- too late to add writes\");\n\n    self.outstanding_writes++;\n    var committed = false;\n    return {\n      committed: function () {\n        if (committed)\n          throw new Error(\"committed called twice on the same write\");\n        committed = true;\n        self.outstanding_writes--;\n        self._maybeFire();\n      }\n    };\n  },\n\n  // Arm the fence. Once the fence is armed, and there are no more\n  // uncommitted writes, it will activate.\n  arm: function () {\n    var self = this;\n    if (self === DDPServer._CurrentWriteFence.get())\n      throw Error(\"Can't arm the current fence\");\n    self.armed = true;\n    self._maybeFire();\n  },\n\n  // Register a function to be called once before firing the fence.\n  // Callback function can add new writes to the fence, in which case\n  // it won't fire until those writes are done as well.\n  onBeforeFire: function (func) {\n    var self = this;\n    if (self.fired)\n      throw new Error(\"fence has already activated -- too late to \" +\n                      \"add a callback\");\n    self.before_fire_callbacks.push(func);\n  },\n\n  // Register a function to be called when the fence fires.\n  onAllCommitted: function (func) {\n    var self = this;\n    if (self.fired)\n      throw new Error(\"fence has already activated -- too late to \" +\n                      \"add a callback\");\n    self.completion_callbacks.push(func);\n  },\n\n  // Convenience function. Arms the fence, then blocks until it fires.\n  armAndWait: function () {\n    var self = this;\n    var future = new Future;\n    self.onAllCommitted(function () {\n      future['return']();\n    });\n    self.arm();\n    future.wait();\n  },\n\n  _maybeFire: function () {\n    var self = this;\n    if (self.fired)\n      throw new Error(\"write fence already activated?\");\n    if (self.armed && !self.outstanding_writes) {\n      function invokeCallback (func) {\n        try {\n          func(self);\n        } catch (err) {\n          Meteor._debug(\"exception in write fence callback\", err);\n        }\n      }\n\n      self.outstanding_writes++;\n      while (self.before_fire_callbacks.length > 0) {\n        var callbacks = self.before_fire_callbacks;\n        self.before_fire_callbacks = [];\n        _.each(callbacks, invokeCallback);\n      }\n      self.outstanding_writes--;\n\n      if (!self.outstanding_writes) {\n        self.fired = true;\n        var callbacks = self.completion_callbacks;\n        self.completion_callbacks = [];\n        _.each(callbacks, invokeCallback);\n      }\n    }\n  },\n\n  // Deactivate this fence so that adding more writes has no effect.\n  // The fence must have already fired.\n  retire: function () {\n    var self = this;\n    if (! self.fired)\n      throw new Error(\"Can't retire a fence that hasn't fired.\");\n    self.retired = true;\n  }\n});\n","// A \"crossbar\" is a class that provides structured notification registration.\n// See _match for the definition of how a notification matches a trigger.\n// All notifications and triggers must have a string key named 'collection'.\n\nDDPServer._Crossbar = function (options) {\n  var self = this;\n  options = options || {};\n\n  self.nextId = 1;\n  // map from collection name (string) -> listener id -> object. each object has\n  // keys 'trigger', 'callback'.  As a hack, the empty string means \"no\n  // collection\".\n  self.listenersByCollection = {};\n  self.listenersByCollectionCount = {};\n  self.factPackage = options.factPackage || \"livedata\";\n  self.factName = options.factName || null;\n};\n\n_.extend(DDPServer._Crossbar.prototype, {\n  // msg is a trigger or a notification\n  _collectionForMessage: function (msg) {\n    var self = this;\n    if (! _.has(msg, 'collection')) {\n      return '';\n    } else if (typeof(msg.collection) === 'string') {\n      if (msg.collection === '')\n        throw Error(\"Message has empty collection!\");\n      return msg.collection;\n    } else {\n      throw Error(\"Message has non-string collection!\");\n    }\n  },\n\n  // Listen for notification that match 'trigger'. A notification\n  // matches if it has the key-value pairs in trigger as a\n  // subset. When a notification matches, call 'callback', passing\n  // the actual notification.\n  //\n  // Returns a listen handle, which is an object with a method\n  // stop(). Call stop() to stop listening.\n  //\n  // XXX It should be legal to call fire() from inside a listen()\n  // callback?\n  listen: function (trigger, callback) {\n    var self = this;\n    var id = self.nextId++;\n\n    var collection = self._collectionForMessage(trigger);\n    var record = {trigger: EJSON.clone(trigger), callback: callback};\n    if (! _.has(self.listenersByCollection, collection)) {\n      self.listenersByCollection[collection] = {};\n      self.listenersByCollectionCount[collection] = 0;\n    }\n    self.listenersByCollection[collection][id] = record;\n    self.listenersByCollectionCount[collection]++;\n\n    if (self.factName && Package['facts-base']) {\n      Package['facts-base'].Facts.incrementServerFact(\n        self.factPackage, self.factName, 1);\n    }\n\n    return {\n      stop: function () {\n        if (self.factName && Package['facts-base']) {\n          Package['facts-base'].Facts.incrementServerFact(\n            self.factPackage, self.factName, -1);\n        }\n        delete self.listenersByCollection[collection][id];\n        self.listenersByCollectionCount[collection]--;\n        if (self.listenersByCollectionCount[collection] === 0) {\n          delete self.listenersByCollection[collection];\n          delete self.listenersByCollectionCount[collection];\n        }\n      }\n    };\n  },\n\n  // Fire the provided 'notification' (an object whose attribute\n  // values are all JSON-compatibile) -- inform all matching listeners\n  // (registered with listen()).\n  //\n  // If fire() is called inside a write fence, then each of the\n  // listener callbacks will be called inside the write fence as well.\n  //\n  // The listeners may be invoked in parallel, rather than serially.\n  fire: function (notification) {\n    var self = this;\n\n    var collection = self._collectionForMessage(notification);\n\n    if (! _.has(self.listenersByCollection, collection)) {\n      return;\n    }\n\n    var listenersForCollection = self.listenersByCollection[collection];\n    var callbackIds = [];\n    _.each(listenersForCollection, function (l, id) {\n      if (self._matches(notification, l.trigger)) {\n        callbackIds.push(id);\n      }\n    });\n\n    // Listener callbacks can yield, so we need to first find all the ones that\n    // match in a single iteration over self.listenersByCollection (which can't\n    // be mutated during this iteration), and then invoke the matching\n    // callbacks, checking before each call to ensure they haven't stopped.\n    // Note that we don't have to check that\n    // self.listenersByCollection[collection] still === listenersForCollection,\n    // because the only way that stops being true is if listenersForCollection\n    // first gets reduced down to the empty object (and then never gets\n    // increased again).\n    _.each(callbackIds, function (id) {\n      if (_.has(listenersForCollection, id)) {\n        listenersForCollection[id].callback(notification);\n      }\n    });\n  },\n\n  // A notification matches a trigger if all keys that exist in both are equal.\n  //\n  // Examples:\n  //  N:{collection: \"C\"} matches T:{collection: \"C\"}\n  //    (a non-targeted write to a collection matches a\n  //     non-targeted query)\n  //  N:{collection: \"C\", id: \"X\"} matches T:{collection: \"C\"}\n  //    (a targeted write to a collection matches a non-targeted query)\n  //  N:{collection: \"C\"} matches T:{collection: \"C\", id: \"X\"}\n  //    (a non-targeted write to a collection matches a\n  //     targeted query)\n  //  N:{collection: \"C\", id: \"X\"} matches T:{collection: \"C\", id: \"X\"}\n  //    (a targeted write to a collection matches a targeted query targeted\n  //     at the same document)\n  //  N:{collection: \"C\", id: \"X\"} does not match T:{collection: \"C\", id: \"Y\"}\n  //    (a targeted write to a collection does not match a targeted query\n  //     targeted at a different document)\n  _matches: function (notification, trigger) {\n    // Most notifications that use the crossbar have a string `collection` and\n    // maybe an `id` that is a string or ObjectID. We're already dividing up\n    // triggers by collection, but let's fast-track \"nope, different ID\" (and\n    // avoid the overly generic EJSON.equals). This makes a noticeable\n    // performance difference; see https://github.com/meteor/meteor/pull/3697\n    if (typeof(notification.id) === 'string' &&\n        typeof(trigger.id) === 'string' &&\n        notification.id !== trigger.id) {\n      return false;\n    }\n    if (notification.id instanceof MongoID.ObjectID &&\n        trigger.id instanceof MongoID.ObjectID &&\n        ! notification.id.equals(trigger.id)) {\n      return false;\n    }\n\n    return _.all(trigger, function (triggerValue, key) {\n      return !_.has(notification, key) ||\n        EJSON.equals(triggerValue, notification[key]);\n    });\n  }\n});\n\n// The \"invalidation crossbar\" is a specific instance used by the DDP server to\n// implement write fence notifications. Listener callbacks on this crossbar\n// should call beginWrite on the current write fence before they return, if they\n// want to delay the write fence from firing (ie, the DDP method-data-updated\n// message from being sent).\nDDPServer._InvalidationCrossbar = new DDPServer._Crossbar({\n  factName: \"invalidation-crossbar-listeners\"\n});\n","if (process.env.DDP_DEFAULT_CONNECTION_URL) {\n  __meteor_runtime_config__.DDP_DEFAULT_CONNECTION_URL =\n    process.env.DDP_DEFAULT_CONNECTION_URL;\n}\n\nMeteor.server = new Server;\n\nMeteor.refresh = function (notification) {\n  DDPServer._InvalidationCrossbar.fire(notification);\n};\n\n// Proxy the public methods of Meteor.server so they can\n// be called directly on Meteor.\n_.each(['publish', 'methods', 'call', 'apply', 'onConnection', 'onMessage'],\n       function (name) {\n         Meteor[name] = _.bind(Meteor.server[name], Meteor.server);\n       });\n"]}